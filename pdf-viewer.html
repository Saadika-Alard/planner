<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PDF Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="js/supabaseClient.js"></script>

<style>
  body {
    margin: 0;
    display: flex;
    height: 100vh;
    font-family: Arial, sans-serif;
    overflow: hidden;
    background: #f8f9f5;
  }

  #sidebar {
    width: 200px;
    background: #eceee8;
    border-right: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
  }

  #thumbContainer canvas {
    margin-bottom: 10px;
    cursor: pointer;
    border-radius: 6px;
    border: 2px solid transparent;
  }

  .thumb-selected {
    border-color: #6b8e23;
    background: #d8e8c8;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #6b8e23;
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header button {
    background: white;
    border: none;
    padding: 7px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin-left: 6px;
  }

  header button:hover {
    background: #f0f0f0;
  }

  iframe {
    flex: 1;
    width: 100%;
    border: none;
    background: white;
  }
</style>
</head>

<body>

<!-- Sidebar -->
<div id="sidebar">
  <h4>Pages</h4>
  <div id="thumbContainer"></div>
</div>

<!-- Main PDF area -->
<div id="main">
  <header>
    <h2 id="pdfTitle">Loading PDFâ€¦</h2>
    <div>
      <button onclick="printSelected()">ðŸ–¨ Print Selected</button>
      <button onclick="printAll()">ðŸ–¨ Print All</button>
      <button onclick="downloadOne()">â¬‡ Download</button>
      <button onclick="downloadAll()">â¬‡ Download All</button>
      <button id="toggleBtn" onclick="togglePack()" style="display:none;">â†” Switch Pack</button>
    </div>
  </header>

  <iframe id="pdfFrame"></iframe>
</div>


<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<!-- PDF-Lib for extracting pages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>


<script>
/* ---------------------------------------------------------
   Load Data
---------------------------------------------------------- */
const supa = getSupabase();
const params = new URLSearchParams(location.search);
const resourceId = params.get("res");
const requestedType = params.get("type");
let pack = null;

async function loadPack() {
  const { data, error } = await supa
    .from("resources")
    .select("title, teaching_pack_url, exercise_pack_url")
    .eq("id", resourceId)
    .single();
  if (error || !data) {
    document.getElementById("pdfTitle").textContent = "Resource not found";
    throw new Error("Missing resource with id " + resourceId);
  }
  pack = data;
  document.getElementById("pdfTitle").textContent = pack.title;
}

/* ---------------------------------------------------------
   Base64 â†’ Blob URL
--------------------------------------------------------- */
async function fetchPdfBytes(url) {
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  return new Uint8Array(buf);
}

/* ---------------------------------------------------------
   Active PDF Pack (teaching or exercise)
--------------------------------------------------------- */
let currentBase64;
let currentLabel;
let pdfUrl;
let pdfBinary = null;

async function initViewer() {
  await loadPack();

  const hasTeaching = Boolean(pack.teaching_pack_url);
  const hasExercise = Boolean(pack.exercise_pack_url);

  if (requestedType === "exercise" && hasExercise) {
    currentBase64 = pack.exercise_pack_url;
    currentLabel = "Exercise Pack";
  } else if (requestedType === "teaching" && hasTeaching) {
    currentBase64 = pack.teaching_pack_url;
    currentLabel = "Teaching Pack";
  } else if (hasTeaching) {
    currentBase64 = pack.teaching_pack_url;
    currentLabel = "Teaching Pack";
  } else {
    currentBase64 = pack.exercise_pack_url;
    currentLabel = "Exercise Pack";
  }

  if (!currentBase64) {
    document.getElementById("pdfTitle").textContent = "No PDF found for this resource";
    throw new Error("Resource does not contain a PDF pack");
  }

  document.getElementById("pdfTitle").textContent = `${pack.title} â€” ${currentLabel}`;
  await setPdf(currentBase64);

  if (hasTeaching && hasExercise) {
    document.getElementById("toggleBtn").style.display = "inline-block";
  }
}

async function setPdf(url) {
  pdfUrl = url;
  document.getElementById("pdfFrame").src = pdfUrl;
  pdfBinary = await fetchPdfBytes(pdfUrl);
  generateThumbnails();
}

/* ---------------------------------------------------------
   Toggle Teaching / Exercise Pack
--------------------------------------------------------- */
async function togglePack() {
  if (currentBase64 === pack.teaching_pack_url) {
    currentBase64 = pack.exercise_pack_url;
    currentLabel = "Exercise Pack";
  } else {
    currentBase64 = pack.teaching_pack_url;
    currentLabel = "Teaching Pack";
  }

  document.getElementById("pdfTitle").textContent = `${pack.title} â€” ${currentLabel}`;
  await setPdf(currentBase64);
}

/* ---------------------------------------------------------
   Thumbnail Rendering
--------------------------------------------------------- */
let selectedPages = [];

async function generateThumbnails() {
  selectedPages = [];

  const pdf = await pdfjsLib.getDocument({ data: pdfBinary }).promise;

  const container = document.getElementById("thumbContainer");
  container.innerHTML = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 0.2 });

    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;

    canvas.onclick = () => {
      if (selectedPages.includes(i)) {
        selectedPages = selectedPages.filter(n => n !== i);
        canvas.classList.remove("thumb-selected");
      } else {
        selectedPages.push(i);
        canvas.classList.add("thumb-selected");
      }
    };

    container.appendChild(canvas);
  }
}

/* ---------------------------------------------------------
   Downloads
--------------------------------------------------------- */
function downloadOne() {
  const a = document.createElement("a");
  a.href = pdfUrl;
  a.download = `${pack.title} - ${currentLabel}.pdf`;
  a.click();
}

function downloadAll() {
  if (pack.teaching_pack_url) {
    const a = document.createElement("a");
    a.href = pack.teaching_pack_url;
    a.download = pack.title + " - Teaching.pdf";
    a.click();
  }
  if (pack.exercise_pack_url) {
    const a = document.createElement("a");
    a.href = pack.exercise_pack_url;
    a.download = pack.title + " - Exercise.pdf";
    a.click();
  }
}

/* ---------------------------------------------------------
   Printing
--------------------------------------------------------- */
function printAll() {
  document.getElementById("pdfFrame").contentWindow.print();
}

async function printSelected() {
  if (!selectedPages.length)
    return alert("Select pages first.");

  const original = await PDFLib.PDFDocument.load(pdfBinary);
  const output = await PDFLib.PDFDocument.create();

  for (const p of selectedPages) {
    const [pg] = await output.copyPages(original, [p - 1]);
    output.addPage(pg);
  }

  const outBytes = await output.save();
  const blobUrl = URL.createObjectURL(new Blob([outBytes], { type: "application/pdf" }));

  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = blobUrl;
  document.body.appendChild(iframe);

  iframe.onload = () => iframe.contentWindow.print();
}

initViewer();
</script>

</body>
</html>
